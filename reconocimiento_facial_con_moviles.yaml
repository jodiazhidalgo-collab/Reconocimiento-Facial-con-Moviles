blueprint:
  name: "ğŸ“± RECONOCIMIENTO FACIAL CON MÃ“VILES (Voz y Notificaciones)"
  description: Detecta a una persona con Double Take, envÃ­a una notificaciÃ³n a los mÃ³viles elegidos y dice una frase aleatoria por Alexa.
  domain: automation
  input:
    # --- PESTAÃ‘A 1: RECONOCIMIENTO ---
    seccion_persona:
      name: "ğŸ‘¤ Â¿A quiÃ©n buscamos?"
      description: "Escribe el nombre exacto que configuraste en tu sistema de reconocimiento (Double Take)."
      icon: mdi:face-recognition
      collapsed: true
      input:
        person_name:
          name: "Nombre de la persona"
          description: "EscrÃ­belo en minÃºsculas."
          default: ""
          selector:
            text: {}

    # --- PESTAÃ‘A 2: ALTAVOZ ---
    seccion_altavoz:
      name: "ğŸ—£ï¸ Altavoz de Salida"
      description: "Configura por dÃ³nde quieres que hable el sistema."
      icon: mdi:account-voice
      collapsed: true
      input:
        alexa_speaker:
          name: "Altavoz Alexa"
          description: "Elige el dispositivo de salida."
          default: 
          selector:
            entity:
              domain: media_player
              integration: alexa_media

    # --- PESTAÃ‘A 3: MENSAJES Y EFECTOS ---
    seccion_mensajes:
      name: "ğŸ’¬ Mensajes de Voz"
      description: |
        Para usar efectos, DEBES empezar la frase con <speak> y terminarla con </speak>.
        Copia estos cÃ³digos y pÃ©galos en tu frase:

        ğŸ¤« SUSURRO: <amazon:effect name='whispered'>TEXTO</amazon:effect>        ğŸ‘ˆ<-- (Sustituye TEXTO por tus palabras)
        
        â© RÃPIDO: <prosody rate='fast'>TEXTO</prosody>                          ğŸ‘ˆ<-- (Sustituye TEXTO por tus palabras)
        
        ğŸ¢ LENTO: <prosody rate='slow'>TEXTO</prosody>                           ğŸ‘ˆ<-- (Sustituye TEXTO por tus palabras)
        
        â±ï¸ PAUSA: <break time='1s'/>                                             ğŸ‘ˆ<-- (Sustituye 1s por los segundos que quieras esperar. Ej: 2s o 500ms)
      icon: mdi:message-text-outline
      collapsed: true
      input:
        voice_messages:
          name: "Frases Aleatorias"
          default: []
          selector:
            text:
              multiple: true

    # --- PESTAÃ‘A 4: NOTIFICACIONES AL MÃ“VIL ---
    seccion_movil:
      name: "ğŸ“± Avisos al MÃ³vil (Obligatorio)"
      description: "Elige a quÃ© mÃ³viles mandar el aviso. (Si no quieres aviso, usa la otra plantilla)."
      icon: mdi:cellphone-message
      collapsed: true
      input:
        notify_device_1:
          name: "MÃ³vil 1"
          default: ""
          selector:
            device:
              integration: mobile_app
        notify_device_2:
          name: "MÃ³vil 2"
          default: ""
          selector:
            device:
              integration: mobile_app

    # --- PESTAÃ‘A 5: TIEMPO DE ESPERA ---
    seccion_tiempo:
      name: "â±ï¸ Tiempo de Anti-RepeticiÃ³n"
      description: "Tiempo que debe pasar antes de que el sistema vuelva a saludar a la misma persona."
      icon: mdi:timer-outline
      collapsed: true
      input:
        cooldown_seconds:
          name: "Segundos de espera"
          description: "Si la cÃ¡mara lo vuelve a ver en este tiempo, lo ignorarÃ¡."
          default: 120
          selector:
            number:
              min: 1
              max: 300
              unit_of_measurement: segundos

mode: single
max_exceeded: silent

variables:
  target_name: !input person_name
  alexa_target: !input alexa_speaker
  mobile_1: !input notify_device_1
  mobile_2: !input notify_device_2
  frases_aleatorias: !input voice_messages

trigger:
  - platform: mqtt
    topic: double-take/matches/#

condition:
  # CondiciÃ³n 1: Comprueba si el nombre coincide con el del MQTT
  - condition: template
    value_template: >
      {{ target_name|lower in trigger.payload_json.match.name|lower 
         if trigger.payload_json.match is defined 
         else (target_name|lower in trigger.payload_json.matches[0].name|lower 
         if trigger.payload_json.matches is defined and trigger.payload_json.matches|length > 0 
         else false) }}
  
  # CondiciÃ³n 2: Comprueba que el altavoz estÃ© configurado para no dar error
  - condition: template
    value_template: "{{ alexa_target != none and alexa_target != '' }}"

action:
  - parallel:
      # ACCION 1: Hablar por Alexa
      - service: notify.alexa_media
        data:
          target: !input alexa_speaker
          data:
            type: tts
          message: "{{ frases_aleatorias | random }}"

      # ACCION 2: Notificar MÃ³vil 1
      - if:
          - condition: template
            value_template: "{{ mobile_1 != none and mobile_1 != '' }}"
        then:
          - domain: mobile_app
            type: notify
            device_id: !input notify_device_1
            message: "Â¡{{ target_name | title }} ha llegado a casa! ğŸ "
            title: "Reconocimiento Facial"

      # ACCION 3: Notificar MÃ³vil 2
      - if:
          - condition: template
            value_template: "{{ mobile_2 != none and mobile_2 != '' }}"
        then:
          - domain: mobile_app
            type: notify
            device_id: !input notify_device_2
            message: "Â¡{{ target_name | title }} ha llegado a casa! ğŸ "
            title: "Reconocimiento Facial"

  # CONTROL DE TIEMPO: Espera X segundos
  - delay:
      seconds: !input cooldown_seconds
